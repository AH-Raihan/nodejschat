<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1,user-scalable=no"
    />
    <title>Message</title>

    <link rel="stylesheet" href="css/style.css" />
  </head>
  <body>
    <h2>AHR Chat</h2>
    <h3>
      <span id="groupName" ondblclick="setGroup();">Group Name</span>
      <span id="userName" ondblclick="setUname();">Name</span>

      <span
        id="usercount"
        title="Lorem ipsum dolor sit amet consectetur adipisicing elit. Mollitia, commodi provident dolores vitae sapiente repellendus labore. Illum consectetur placeat eos nobis? Blanditiis, est dolorum. Incidunt veritatis ea tenetur suscipit officia? "
        >0</span
      >
    </h3>
    <div class="container">
      <ul id="chatlist"></ul>

      <div class="sendsection">
        <input id="texts" />
        <button id="send" onclick="sendMessage();">Send</button>
      </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
      const usercount = document.getElementById("usercount");
      const chatlist = document.getElementById("chatlist");
      const sendBtn = document.getElementById("send");
      const textareas = document.getElementById("texts");
      const userName = document.getElementById("userName");
      const groupName = document.getElementById("groupName");
      var nameOfGroup = "";
      var nameOfUser = "";
      const sound = new Audio("/sound");
      let socket = io();

      // set username

      if (localStorage.getItem("username")) {
        nameOfUser = localStorage.getItem("username");
        userName.innerHTML = localStorage.getItem("username");
      } else {
        nameOfUser = "unknown";
        userName.innerHTML = nameOfUser;
      }
      function setUname() {
        const uname = prompt("Your Name");
        if (uname != null) {
          localStorage.setItem("username", uname);
          userName.innerHTML = uname;
        }
      }

      // set groupname
      if (localStorage.getItem("groupname")) {
        groupName.innerHTML = localStorage.getItem("groupname");
      }
      function setGroup() {
        const gname = prompt("Group Name");
        if (gname != null) {
          localStorage.setItem("groupname", gname);
          groupName.innerHTML = gname;
        }
      }
      // group and uname check
      if (localStorage.getItem("groupname") === null) {
        setGroup();
      }
      if (localStorage.getItem("username") === null) {
        setUname();
      }

      // make group
      var nameOfGroup = "allpublic";
      if (localStorage.getItem("groupname") === null) {
        socket.emit("group-name", nameOfGroup);
      } else {
        nameOfGroup = localStorage.getItem("groupname");
        socket.emit("group-name", [nameOfGroup, nameOfUser]);
      }
      // joined user count
      socket.on(nameOfGroup, (counted) => {
        usercount.innerHTML = counted[0];
      });
      // leave msg
      socket.on("leavemsg", (msg) => {
        socket.emit("group-name", [nameOfGroup,nameOfUser]);
      });

      // Enter click msg send
      window.addEventListener("keydown", (event) => {
        if (event.keyCode === 13) {
          sendMessage();
        }
      });
      // send message
      function sendMessage() {
        if (textareas.value != " " && textareas.value !== "") {
          let newmsg = textareas.value;
          socket.emit("chat", {
            textmsg: newmsg,
            userid: socket.id,
            groupid: nameOfGroup,
            username: nameOfUser,
          });
          textareas.value = "";
        }
      }

      // chat transfer to server
      socket.on("chat-transfer", (msg) => {
        let iam = "";
        let li = document.createElement("li");
        if (msg[1] === socket.id) {
          li.classList.add("s2");
        } else {
          sound.play();
          li.classList.add("s1");
          iam = msg[2].slice(0, 1) + ": ";
        }

        li.textContent = iam + msg[0];

        chatlist.appendChild(li);
        chatlist.scrollTo(0, chatlist.scrollHeight);
      });
    </script>


  </body>
</html>
